networks:
  app-network:
    driver: bridge

volumes:
  pg_data_17:

services:
  api:
    build:
      context: .
      dockerfile: api.Dockerfile
    image: ${API_IMAGE_NAME:-mock_api}
    profiles:
      - app
      - api
    environment:
      - HOST=${HOST}
      - PORT=${PORT}

      - REDIS_HOST=${REDIS_HOST:-mem_db}
      - REDIS_PORT=${REDIS_PORT:-6379}

      - POSTGRES_HOST=${POSTGRES_HOST:-sql_db}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-pguser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-pgpwd}
      - POSTGRES_DB=${POSTGRES_DB:-dev}
    depends_on:
      mem_db:
        condition: service_started
      sql_db:
        condition: service_healthy
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
    networks:
      - app-network

  load_balancer:
    image: nginx:1-alpine
    profiles:
      - app
    depends_on:
      - api
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "${LOAD_BALANCER_PORT}:80"
    networks:
      - app-network
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

  mem_db:
    image: redis:7-alpine
    profiles:
      - db
    networks:
      - app-network
    ports:
      - 16379:6379
    deploy:
      restart_policy:
        condition: on-failure
    healthcheck:
      test: |
        redis-cli --raw incr ping
      interval: 5s
      timeout: 2s
      retries: 3
      # start_period: 1s

  sql_db:
    image: postgres:17-alpine
    profiles:
      - db
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
      - POSTGRES_USER=${POSTGRES_USER:-pguser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-pgpwd}
      - POSTGRES_DB=${POSTGRES_DB:-dev}
    networks:
      - app-network
    ports:
      - 15432:5432
    volumes:
      - pg_data_17:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-pguser} -d ${POSTGRES_DB:-dev}"]
      interval: 5s
      timeout: 15s
      retries: 10
    deploy:
      restart_policy:
        condition: on-failure
